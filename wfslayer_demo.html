<html> 
<head> 
<title>My first Three.js app</title>
<style>canvas { width: 100%; height: 100% }</style> 
<!--script src="jquery-ui-1.11.0/jquery-ui.js"></script>
<link  rel="stylesheet" href="jquery-ui-1.11.0/jquery-ui.theme.css"/>
<link  rel="stylesheet" href="jquery-ui-1.11.0/jquery-ui.structure.css"/-->
</head> 
<body> 
<div id="header"><p id="header_text">hello</p></div>
<div id="container"></div>
<script src="thirdparty/three.js/build/three.js"></script> 
<script src="thirdparty/three.js/examples/js/controls/TrackballControls.js"></script>
<script src="thirdparty/three.js/examples/js/Detector.js"></script>
<script src="thirdparty/three.js/examples/js/libs/stats.min.js"></script>
<script src="thirdparty/three.js/examples/js/postprocessing/EffectComposer.js"></script>
<script src="thirdparty/three.js/examples/js/postprocessing/RenderPass.js"></script>
<script src="thirdparty/three.js/examples/js/postprocessing/ShaderPass.js"></script>
<script src="thirdparty/three.js/examples/js/postprocessing/BokehPass.js"></script>
<script src="thirdparty/three.js/examples/js/ShaderTerrain.js"></script>
<script src="thirdparty/three.js/examples/fonts/helvetiker_regular.typeface.js"></script>
<script src="thirdparty/three.js/src/extras/GeometryUtils.js"></script>
<script src="thirdparty/proj4-src.js"></script>
<script src="thirdparty/proj4-srs.js"></script>
<script src="thirdparty/jquery-2.1.1.js"></script>
<script src="thirdparty/poly2tri.js"></script>
<script src="thirdparty/clipper.js"></script>
<script src="js/Terrain.js"></script>
<script src="js/WfsLayer.js"></script>
<script src="js/Tiler.js"></script>
<script src="js/ShaderDraping.js"></script>
<script src="js/PlaneGeometry.js"></script>
<script> 

var container, stats;
var camera, controls, scene, renderer;
//var projector;

init();
animate();

function init() {
    window.addEventListener( 'resize', onWindowResize, false );

    container = document.getElementById( 'container' );
    {
        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
    }

    // camera
    {
        camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 10, 100000 );
        camera.position.z = 500;
    }

    // trackball
    {
        controls = new THREE.TrackballControls( camera );
        controls.addEventListener( 'change', render );
    }

    // renderer
    {
        renderer = new THREE.WebGLRenderer( { antialias: false } );
        renderer.setClearColor( 0x222222, 1 );
        renderer.setSize( window.innerWidth, window.innerHeight );
    }

    // stats
    {
        container.appendChild( renderer.domElement );

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '150px';
        stats.domElement.style.zIndex = 100;
        container.appendChild( stats.domElement );
    }


    // scene
    {
        scene = new THREE.Scene();

        scene.add( new THREE.Mesh( new THREE.BoxGeometry(100,100,100),   
                new THREE.MeshLambertMaterial({ambient:0xff0000, color:0xff0000 })));
        // grid
        {
            var helper = new THREE.GridHelper( 200, 10 );
            helper.setColors( 0x0000ff, 0xf0f0f0 );
            helper.rotation.x = -Math.PI/2;
            scene.add( helper );
        }

        // terrain + wfs
        {
            var urlWfsBati = "http://localhost/cgi-bin/tinyows.fcgi?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&typeName=tows:toitures&outputFormat=JSON";
            var symbology = {polygon:{color:0x00ff00, extrude:'hfacade', lineColor:0xff0000, lineWidth:2, opacity:.3}};

            var translation = new THREE.Vector3(-1849500, -5173000, 0);
            var wfsBati = new WfsLayer(urlWfsBati, translation, 32, null, symbology);
            var tiler = new Tiler([wfsBati], translation, 1);
            var nbTiles = 1;
            var tileSize = 300;
            for (var i = 0; i<nbTiles; i++){
                for (var j = 0; j<nbTiles; j++){
                    tiler.tile(new THREE.Vector3(i*tileSize,j*tileSize,0), tileSize, 
                            function(object){
                                for ( var lid = 0, l = object.length; lid < l; lid++ ) {
                                    scene.add(object[lid]);
                                }
                                render();
                            });
                }
            }
        }


        // light
        {
            // add subtle ambient lighting
            var ambientLight = new THREE.AmbientLight(0xaaaaaa);
            scene.add(ambientLight);
            
            // directional lighting
            var directionalLight = new THREE.DirectionalLight(0xffffff);
            directionalLight.position.set(1, 10, 1).normalize();
            scene.add(directionalLight);
        }
    }


    // first render to avoid blank screen before interaction
    render();

}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
    controls.handleResize();
    render();
}

function animate() {
    requestAnimationFrame( animate );
    controls.update();
}

function render() {
    renderer.render(scene, camera);
    stats.update();
}

function onDocumentMouseDown( event ) {
    event.preventDefault();

    var objects = [];
    scene.traverse( function(obj) {
        if ( obj.userData && obj.userData.faceGidMap ) {
            objects.push( obj );
        }
    });

    // WATCHOUT! the position must be relative to the canvas

    var vector = new THREE.Vector3( ( (event.clientX - container.offsetLeft) / window.innerWidth ) * 2 - 1, 
                                  - ( (event.clientY - container.offsetTop) / window.innerHeight ) * 2 + 1, 0.5 );
    var projector = new THREE.Projector();
    vector = projector.unprojectVector( vector, camera );

    var raycaster = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );

    var intersects = raycaster.intersectObjects( objects );

    if ( intersects.length > 0 ) {
        console.log('intersection ',intersects[ 0 ].object.userData.name,' gid', intersects[ 0 ].object.userData.faceGidMap[ intersects[ 0 ].faceIndex ])
    }

}
</script> 
</body> 
</html>
